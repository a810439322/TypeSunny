# TypeSunny 文来登录集成示例

## 在主窗口中集成文来登录

### 1. 添加命名空间引用

```csharp
using TypeSunny.ArticleSender;
using TypeSunny.Net;
```

### 2. 在MainWindow类中添加WenlaiHelper实例

```csharp
public partial class MainWindow : Window
{
    private WenlaiHelper wenlaiHelper;

    public MainWindow()
    {
        InitializeComponent();

        // 初始化文来Helper
        wenlaiHelper = new WenlaiHelper();
    }
}
```

### 3. 添加菜单项（XAML）

在MainWindow.xaml中添加文来相关菜单：

```xml
<Menu>
    <MenuItem Header="文来">
        <MenuItem x:Name="menuItemWenlaiLogin" Header="登录" Click="MenuItemWenlaiLogin_Click"/>
        <MenuItem x:Name="menuItemWenlaiRegister" Header="注册" Click="MenuItemWenlaiRegister_Click"/>
        <Separator/>
        <MenuItem Header="载文" Click="MenuItemWenlaiLoadArticle_Click"/>
    </MenuItem>
</Menu>
```

### 4. 实现菜单点击事件（C#）

```csharp
// 文来登录
private void MenuItemWenlaiLogin_Click(object sender, RoutedEventArgs e)
{
    wenlaiHelper.ShowLoginDialog(this);

    // 更新登录状态显示
    if (wenlaiHelper.IsLoggedIn())
    {
        string username = wenlaiHelper.GetCurrentUsername();
        menuItemWenlaiLogin.Header = $"已登录: {username}";
    }
    else
    {
        menuItemWenlaiLogin.Header = "登录";
    }
}

// 文来注册
private void MenuItemWenlaiRegister_Click(object sender, RoutedEventArgs e)
{
    wenlaiHelper.ShowRegisterDialog(this);

    // 注册成功后更新登录状态
    if (wenlaiHelper.IsLoggedIn())
    {
        string username = wenlaiHelper.GetCurrentUsername();
        menuItemWenlaiLogin.Header = $"已登录: {username}";
    }
}

// 文来载文（现在支持Cookie，登录后可自动访问）
private async void MenuItemWenlaiLoadArticle_Click(object sender, RoutedEventArgs e)
{
    try
    {
        // 从账号管理器加载Cookie
        var accountManager = new AccountSystemManager();
        var account = accountManager.GetAccount("文来");

        if (account != null && !string.IsNullOrWhiteSpace(account.Cookies))
        {
            string apiUrl = Config.GetString("文来接口地址");
            ArticleFetcher.LoadCookiesFromString(apiUrl, account.Cookies);
        }

        // 获取文章（Cookie会自动发送）
        var article = await ArticleFetcher.FetchArticleAsync(3, 500);

        // 处理返回结果
        if (article.Title == "接口错误")
        {
            MessageBox.Show(article.Content, "错误", MessageBoxButton.OK, MessageBoxImage.Warning);

            // 如果是"请先登录"，提示用户登录
            if (article.Content.Contains("登录"))
            {
                wenlaiHelper.ShowLoginDialog(this);
            }
        }
        else
        {
            // 显示文章内容
            // txtArticle.Text = article.Content;
            MessageBox.Show($"载文成功：{article.Title}", "提示", MessageBoxButton.OK, MessageBoxImage.Information);
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show($"载文失败: {ex.Message}", "错误", MessageBoxButton.OK, MessageBoxImage.Error);
    }
}
```

### 5. 窗口加载时检查登录状态

```csharp
private void Window_Loaded(object sender, RoutedEventArgs e)
{
    // 检查文来登录状态
    if (wenlaiHelper.IsLoggedIn())
    {
        string username = wenlaiHelper.GetCurrentUsername();
        menuItemWenlaiLogin.Header = $"已登录: {username}";
    }

    // 从账号管理器加载Cookie到ArticleFetcher
    var accountManager = new AccountSystemManager();
    var account = accountManager.GetAccount("文来");
    if (account != null && !string.IsNullOrWhiteSpace(account.Cookies))
    {
        string apiUrl = Config.GetString("文来接口地址");
        ArticleFetcher.LoadCookiesFromString(apiUrl, account.Cookies);
    }
}
```

## 完整示例：处理登录流程

```csharp
public class WenlaiLoginManager
{
    private WenlaiHelper wenlaiHelper;
    private AccountSystemManager accountManager;

    public WenlaiLoginManager()
    {
        wenlaiHelper = new WenlaiHelper();
        accountManager = new AccountSystemManager();
    }

    /// <summary>
    /// 确保已登录（如果未登录则显示登录对话框）
    /// </summary>
    public bool EnsureLoggedIn(Window owner)
    {
        if (wenlaiHelper.IsLoggedIn())
        {
            // 加载Cookie
            LoadCookies();
            return true;
        }

        // 显示登录对话框
        wenlaiHelper.ShowLoginDialog(owner);

        if (wenlaiHelper.IsLoggedIn())
        {
            LoadCookies();
            return true;
        }

        return false;
    }

    /// <summary>
    /// 加载Cookie到ArticleFetcher
    /// </summary>
    private void LoadCookies()
    {
        var account = accountManager.GetAccount("文来");
        if (account != null && !string.IsNullOrWhiteSpace(account.Cookies))
        {
            string apiUrl = Config.GetString("文来接口地址");
            ArticleFetcher.LoadCookiesFromString(apiUrl, account.Cookies);
        }
    }

    /// <summary>
    /// 载文（自动处理登录）
    /// </summary>
    public async Task<ArticleData> LoadArticleAsync(Window owner, int difficulty = 3, int maxLength = 500)
    {
        // 确保已登录
        if (!EnsureLoggedIn(owner))
        {
            return new ArticleData
            {
                Title = "未登录",
                Content = "用户取消登录",
                FullContent = "",
                Mark = ""
            };
        }

        // 获取文章
        var article = await ArticleFetcher.FetchArticleAsync(difficulty, maxLength);

        // 如果返回"请先登录"，尝试重新登录
        if (article.Title == "接口错误" && article.Content.Contains("登录"))
        {
            // Cookie可能过期，尝试重新登录
            if (EnsureLoggedIn(owner))
            {
                // 重新获取文章
                article = await ArticleFetcher.FetchArticleAsync(difficulty, maxLength);
            }
        }

        return article;
    }
}
```

## 使用WenlaiLoginManager

```csharp
public partial class MainWindow : Window
{
    private WenlaiLoginManager wenlaiManager;

    public MainWindow()
    {
        InitializeComponent();
        wenlaiManager = new WenlaiLoginManager();
    }

    private async void MenuItemWenlaiLoadArticle_Click(object sender, RoutedEventArgs e)
    {
        var article = await wenlaiManager.LoadArticleAsync(this, 3, 500);

        if (article.Title == "接口错误" || article.Title == "未登录")
        {
            MessageBox.Show(article.Content, "错误", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
        else
        {
            // 显示文章
            txtArticle.Text = article.Content;
        }
    }
}
```

## 注意事项

1. **Cookie自动管理**: 登录后Cookie会自动保存，下次启动应用时自动加载
2. **Cookie过期处理**: 当Cookie过期时（7天后），需要重新登录
3. **同域名共享**: 如果文来和赛文使用相同域名，登录一个即可访问另一个
4. **错误处理**: 建议检查返回的`article.Title`是否为"接口错误"，并根据`article.Content`提示用户

## 测试流程

1. 首次启动：显示"登录"按钮
2. 点击"注册"：输入用户名和密码，勾选"注册后自动登录"
3. 注册成功：自动登录，按钮显示"已登录: xxx"
4. 点击"载文"：成功获取文章（Cookie自动发送）
5. 重启应用：自动加载Cookie，无需重新登录
6. 7天后：Cookie过期，需要重新登录
